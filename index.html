<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>ูุฑู ฺฏุฒุงุฑุด ุจุงุฒุฏุฏ ู ูพุดุชุจุงู ุญุถูุฑ</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Icons -->
    <link rel="icon" href="icons/icon-192.png" sizes="192x192">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        body{font-family:'Tahoma',sans-serif;background-color:#f5f7fa;margin:0;padding:20px;color:#333}.container{max-width:900px;margin:0 auto;background:white;padding:40px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}.header{text-align:center;border-bottom:3px solid #007bff;padding-bottom:20px;margin-bottom:30px}.header h1{color:#007bff;font-size:28px;margin:0}.header p{color:#666;font-size:16px}.form-group{margin-bottom:20px}.form-row{display:flex;gap:20px}.form-row .form-group{flex:1}label{display:block;font-weight:700;color:#555;margin-bottom:5px}input,textarea,select{width:100%;padding:10px;border:2px solid #ddd;border-radius:5px;font-size:14px;box-sizing:border-box;transition:border-color .3s}input:focus,textarea:focus,select:focus{border-color:#007bff;outline:0}textarea{height:80px;resize:vertical}.footer{text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid #eee;color:#777;font-size:12px}.signature{display:flex;gap:20px;margin-top:20px}.signature .form-group{flex:1}@media (max-width:600px){.form-row,.signature{flex-direction:column}.container{padding:20px}input,select{font-size:16px}}.error{border-color:#dc3545 !important}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>๐งพ ูุฑู ฺฏุฒุงุฑุด ุจุงุฒุฏุฏ ู ูพุดุชุจุงู ุญุถูุฑ</h1>
            <p>ุซุจุช ุฏูู ุฌุฒุฆุงุช ุจุงุฒุฏุฏ ุจุฑุง ูพฺฏุฑ ู ุจุงฺฏุงู</p>
            <small>ุดูุงุฑู ฺฏุฒุงุฑุด: <input type="text" id="reportNumber" style="width:150px;display:inline;border:1px solid #ddd;padding:5px;" placeholder="ูุซุงู: RW-001" required pattern="[A-Z]{2}-\d{3}"> | 
            ุชุงุฑุฎ ฺฏุฒุงุฑุด: <input type="date" id="reportDate" required></small>
        </div>

        <form id="reportForm" novalidate>
            <h3 style="color:#007bff;border-bottom:1px solid #ddd;padding-bottom:10px;">ุงุทูุงุนุงุช ุจุงุฒุฏุฏฺฉููุฏู/ูพุดุชุจุงู</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="visitorName">ูุงู ู ูุงู ุฎุงููุงุฏฺฏ:</label>
                    <input type="text" id="visitorName" name="visitorName" required aria-label="ูุงู ุจุงุฒุฏุฏฺฉููุฏู">
                </div>
                <div class="form-group">
                    <label for="position">ุณูุช/ููุด:</label>
                    <input type="text" id="position" name="position" placeholder="ูุซุงู: ฺฉุงุฑุดูุงุณ ูู">
                </div>
            </div>

            <h3 style="color:#007bff;border-bottom:1px solid #ddd;padding-bottom:10px;">ุงุทูุงุนุงุช ูุดุชุฑ/ูุญู ุจุงุฒุฏุฏ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="clientName">ูุงู ูุดุชุฑ:</label>
                    <input type="text" id="clientName" name="clientName" required aria-label="ูุงู ูุดุชุฑ">
                </div>
                <div class="form-group">
                    <label for="clientContact">ุดูุงุฑู ุชูุงุณ:</label>
                    <input type="tel" id="clientContact" name="clientContact" pattern="[0-9]{11}">
                </div>
            </div>
            <div class="form-group">
                <label for="address">ุขุฏุฑุณ ูุญู ุจุงุฒุฏุฏ:</label>
                <input type="text" id="address" name="address" placeholder="ุขุฏุฑุณ ฺฉุงูู">
            </div>

            <h3 style="color:#007bff;border-bottom:1px solid #ddd;padding-bottom:10px;">ุฌุฒุฆุงุช ุจุงุฒุฏุฏ</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="startTime">ุณุงุนุช ุดุฑูุน:</label>
                    <input type="time" id="startTime" name="startTime">
                </div>
                <div class="form-group">
                    <label for="endTime">ุณุงุนุช ูพุงุงู:</label>
                    <input type="time" id="endTime" name="endTime">
                </div>
            </div>
            <div class="form-group">
                <label for="purpose">ูุฏู ุจุงุฒุฏุฏ:</label>
                <select id="purpose" name="purpose" required>
                    <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
                    <option value="routine">ุจุงุฒุฏุฏ ุฏูุฑูโุง</option>
                    <option value="complaint">ูพุดุชุจุงู ุจุฑ ุงุณุงุณ ุดฺฉุงุช</option>
                    <option value="maintenance">ูฺฏูุฏุงุฑ ู ุชุนูุฑ</option>
                    <option value="inspection">ุจุงุฒุฑุณ ูู</option>
                    <option value="other">ุณุงุฑ</option>
                </select>
            </div>

            <h3 style="color:#007bff;border-bottom:1px solid #ddd;padding-bottom:10px;">ูุณุงุฆู ูุดุงูุฏู ุดุฏู ู ุงูุฏุงูุงุช</h3>
            <div class="form-group">
                <label for="issues">ูุณุงุฆู ู ูุดฺฉูุงุช ูุดุงูุฏู ุดุฏู:</label>
                <textarea id="issues" name="issues" placeholder="ุชูุถุญ ุฏูู ูุณุงุฆู ููุ ุธุงูุฑ ุง ุนููุงุช..."></textarea>
            </div>
            <div class="form-group">
                <label for="actions">ุงูุฏุงูุงุช ุงูุฌุงู ุดุฏู:</label>
                <textarea id="actions" name="actions" placeholder="ูุณุช ุงูุฏุงูุงุชุ ุชุนูุฑุงุชุ ุชูุธูุงุช..."></textarea>
            </div>
            <div class="form-group">
                <label for="recommendations">ุชูุตูโูุง ู ูพฺฏุฑโูุง ุจุนุฏ:</label>
                <textarea id="recommendations" name="recommendations" placeholder="ูพุดููุงุฏุงุช ุจุฑุง ุจูุจูุฏ ุง ุจุงุฒุฏุฏ ุจุนุฏ..."></textarea>
            </div>

            <div class="form-group">
                <label for="status">ูุถุนุช ููุง:</label>
                <select id="status" name="status" required>
                    <option value="">ุงูุชุฎุงุจ ฺฉูุฏ</option>
                    <option value="resolved">ุญู ุดุฏู</option>
                    <option value="inProgress">ุฏุฑ ุญุงู ุจุฑุฑุณ</option>
                    <option value="pending">ูุงุฒ ุจู ูพฺฏุฑ</option>
                    <option value="escalated">ุงุฑุฌุงุน ุจู ุณุทุญ ุจุงูุงุชุฑ</option>
                </select>
            </div>

            <h3 style="color:#007bff;border-bottom:1px solid #ddd;padding-bottom:10px;">ุงูุถุง ู ุชุฃุฏ</h3>
            <div class="signature">
                <div class="form-group">
                    <label for="visitorSign">ุงูุถุง ุจุงุฒุฏุฏฺฉููุฏู:</label>
                    <input type="text" id="visitorSign" name="visitorSign" placeholder="ูุงู ู ุงูุถุง ุฏุฌุชุงู">
                </div>
                <div class="form-group">
                    <label for="clientSign">ุงูุถุง ูุดุชุฑ:</label>
                    <input type="text" id="clientSign" name="clientSign" placeholder="ูุงู ู ุงูุถุง ุฏุฌุชุงู">
                </div>
            </div>

            <div style="text-align:center;margin-top:30px;">
                <button type="submit" id="submitBtn" style="background:#007bff;color:white;padding:12px 30px;border:none;border-radius:5px;font-size:16px;cursor:pointer;">ุฐุฎุฑู ู ุงุฑุณุงู ฺฏุฒุงุฑุด</button>
            </div>
        </form>

        <div class="footer">
            <p>ุชูู ุดุฏู ุชูุณุท: ุฏุงุฏู ูพุฑุฏุงุฒุงู ููุฌ ูุจุชฺฉุฑ | ุชูุงุณ: ฐนฑฑฑตธฒดถถ | ุงูู: info@innowaveco.ir</p>
            <p><small>ุงู ูุฑู ุจุฑุง ุจุงฺฏุงู ู ูพฺฏุฑ ุงุณุชูุงุฏู ุดูุฏ. ุชุงุฑุฎ ฺุงูพ: <span id="printDate"></span></small></p>
        </div>
    </div>

    <script>
        // PWA: Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered successfully!'))
                .catch(err => console.log('SW registration failed:', err));
        }

        // Draft Auto-save
        const form = document.getElementById('reportForm');
        const saveDraft = () => {
            const data = new FormData(form).entries();
            const draft = Object.fromEntries(data);
            localStorage.setItem('reportDraft', JSON.stringify(draft));
        };
        form.addEventListener('input', () => setTimeout(saveDraft, 10000));
        window.addEventListener('beforeunload', saveDraft);

        // Load Draft
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('fa-IR');
            const draft = localStorage.getItem('reportDraft');
            if (draft) {
                const data = JSON.parse(draft);
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = data[key];
                });
            }
        });

        // Validation - FIXED: Hard check for reportNumber
        form.addEventListener('submit', (e) => {
            let valid = true;
            form.querySelectorAll('[required]').forEach(el => {
                if (!el.value.trim()) {
                    el.classList.add('error');
                    valid = false;
                } else el.classList.remove('error');
            });
            // Extra check for reportNumber pattern
            const reportNum = document.getElementById('reportNumber');
            if (!reportNum.value.trim() || !/^[A-Z]{2}-\d{3}$/.test(reportNum.value.trim())) {
                reportNum.classList.add('error');
                valid = false;
                alert('ุดูุงุฑู ฺฏุฒุงุฑุด ุงูุฒุงู ู ุจุงุฏ ูุฑูุช RW-001 ุฏุงุดุชู ุจุงุดุฏ.');
            }
            if (!valid) {
                e.preventDefault();
                return;
            }
            const tel = document.getElementById('clientContact');
            if (tel.value && !/^\d{11}$/.test(tel.value.replace(/[^0-9]/g, ''))) {
                tel.classList.add('error');
                e.preventDefault();
                alert('ุดูุงุฑู ุชูุงุณ ูุงูุนุชุจุฑ ุงุณุช.');
                return;
            }
        });

        // ุชุงุจุนโูุง ุชุฑุฌูู
        function getStatusText(statusValue) {
            const statusMap = {'resolved':'ุญู ุดุฏู','inProgress':'ุฏุฑ ุญุงู ุจุฑุฑุณ','pending':'ูุงุฒ ุจู ูพฺฏุฑ','escalated':'ุงุฑุฌุงุน ุจู ุณุทุญ ุจุงูุงุชุฑ'};
            return statusMap[statusValue] || statusValue;
        }
        function getPurposeText(purposeValue) {
            const purposeMap = {'routine':'ุจุงุฒุฏุฏ ุฏูุฑูโุง','complaint':'ูพุดุชุจุงู ุจุฑ ุงุณุงุณ ุดฺฉุงุช','maintenance':'ูฺฏูุฏุงุฑ ู ุชุนูุฑ','inspection':'ุจุงุฒุฑุณ ูู','other':'ุณุงุฑ'};
            return purposeMap[purposeValue] || purposeValue;
        }

        // Submit Handler - FIXED: Plain text email body (beautiful format)
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            data.timestamp = new Date().toISOString();
            // FIXED: Ensure no undefined
            Object.keys(data).forEach(key => { if (data[key] === undefined) data[key] = ''; });

            console.log('ฺฏุฒุงุฑุด ุฌุฏุฏ:', data);
            const statusText = getStatusText(data.status);
            const purposeText = getPurposeText(data.purpose);
            const summary = `ฺฏุฒุงุฑุด ุจุง ููููุช ุฐุฎุฑู ุดุฏ!\nุดูุงุฑู: ${data.reportNumber || 'ูุงูุดุฎุต'}\nูุดุชุฑ: ${data.clientName || 'ูุงูุดุฎุต'}\nูุฏู: ${purposeText || 'ูุงูุดุฎุต'}\nูุถุนุช: ${statusText}\nุชุงุฑุฎ: ${data.reportDate}`;
            alert(summary);

            // JSON Download (ูุซู ูุจู)
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ฺฏุฒุงุฑุด-ุจุงุฒุฏุฏ-${data.reportNumber || 'ูุงูุดุฎุต'}-${data.reportDate}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // PDF (ูุซู ูุจู)
            const element = document.querySelector('.container');
            const opt = {
                margin: 0.5,
                filename: `ฺฏุฒุงุฑุด-ุจุงุฒุฏุฏ-${data.reportNumber || 'ูุงูุดุฎุต'}-${data.reportDate}.pdf`,
                image: {type: 'jpeg', quality: 0.98},
                html2canvas: {scale: 2, useCORS: true, letterRendering: true, allowTaint: true},
                jsPDF: {unit: 'in', format: 'a4', orientation: 'portrait', putOnlyUsedFonts: true, floatPrecision: 16}
            };
            html2pdf().set(opt).from(element).save().catch(error => {
                console.error('ุฎุทุง ุฏุฑ ุชููุฏ PDF:', error);
                alert('ุฎุทุง ุฏุฑ ุชููุฏ PDF. ูุทูุงู ุงุฒ JSON ุงุณุชูุงุฏู ฺฉูุฏ.');
            });

            // FIXED: Plain Text Email Body - Beautiful Format
            const reportNum = data.reportNumber || 'ูุงูุดุฎุต';
            const emailBody = `
๐งพ ฺฏุฒุงุฑุด ุจุงุฒุฏุฏ ู ูพุดุชุจุงู ุญุถูุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุฌุฒุฆุงุช ฺฉุงูู ฺฏุฒุงุฑุด ุจุฑุง ุจุงฺฏุงู ู ูพฺฏุฑ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ุงุทูุงุนุงุช ฺฉู:
- ุดูุงุฑู ฺฏุฒุงุฑุด: ${reportNum}
- ุชุงุฑุฎ ฺฏุฒุงุฑุด: ${data.reportDate}
- ุฒูุงู ุงุฑุณุงู: ${new Date(data.timestamp).toLocaleString('fa-IR')}

๐ค ุงุทูุงุนุงุช ุจุงุฒุฏุฏฺฉููุฏู:
- ูุงู ู ูุงู ุฎุงููุงุฏฺฏ: ${data.visitorName || '
